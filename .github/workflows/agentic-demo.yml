name: Agentic Automation Workflow - E2E Demo

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  agentic-demo:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'adopt'

    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Install Python dependencies
      working-directory: agent-service
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Generate features and pages (RAG)
      working-directory: agent-service
      run: |
        python agent_service/run_flow_demo.py \
          --module github_actions_demo \
          --requirement "As a user I want to log in with username and password so I can access my inventory"

    - name: Display generated files
      run: |
        echo "=== Generated Feature Files ==="
        find src/test/resources/features/github_actions_demo -name "*.feature" -exec cat {} \;
        echo ""
        echo "=== Generated Page Objects ==="
        find src/main/java/org/example/pages/github_actions_demo -name "*.java" -exec cat {} \;

    - name: Run Maven tests
      run: mvn clean verify -X

    # Restore Allure history from GitHub Pages for trend graphs
    - name: Get Allure history from GitHub Pages
      uses: actions/checkout@v4
      if: always()
      continue-on-error: true
      with:
        ref: gh-pages
        path: gh-pages

    - name: Copy Allure history for trend graphs
      if: always()
      continue-on-error: true
      run: |
        mkdir -p target/allure-results
        if [ -d "gh-pages/history" ]; then
          cp -r gh-pages/history target/allure-results/history
          echo "âœ… Allure history restored for trend graphs"
        else
          echo "â„¹ï¸ No previous Allure history found - this may be the first run"
        fi

    - name: Generate Allure Report
      if: always()
      run: mvn allure:report -q

    - name: Upload Allure Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-report
        path: target/allure-report/
        retention-days: 30

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          target/surefire-reports/
          target/cucumber-reports/
        retention-days: 30

    - name: Publish inline test results as GitHub Check
      if: always()
      uses: EnricoMi/publish-unit-test-result-action@v2
      with:
        files: target/surefire-reports/**/*.xml
        check_name: "Cucumber Test Results"
        comment_mode: always

    - name: Write Test Summary to Job Summary
      if: always()
      run: |
        echo "## ðŸ§ª Test Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f "target/allure-results/cucumber.json" ]; then
          python3 - << 'EOF' >> $GITHUB_STEP_SUMMARY
        import json

        try:
            with open("target/allure-results/cucumber.json") as f:
                data = json.load(f)
            passed = failed = skipped = 0
            for feature in data:
                for scenario in feature.get("elements", []):
                    steps = scenario.get("steps", [])
                    statuses = [s.get("result", {}).get("status", "skipped") for s in steps if steps]
                    if not steps:
                        skipped += 1
                    elif "failed" in statuses:
                        failed += 1
                    elif all(s == "passed" for s in statuses):
                        passed += 1
                    else:
                        skipped += 1
            total = passed + failed + skipped
            print("| Status | Count |")
            print("| --- | --- |")
            print(f"| âœ… Passed | {passed} |")
            print(f"| âŒ Failed | {failed} |")
            print(f"| â­ï¸ Skipped | {skipped} |")
            print(f"| ðŸ“Š **Total** | **{total}** |")
        except Exception as e:
            print(f"| âš ï¸ Could not parse results | {e} |")
        EOF
        else
          echo "âš ï¸ No Cucumber JSON results found" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Reports" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ **Full Allure Report (GitHub Pages):** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¦ **Allure Report Artifact:** Download from the *Artifacts* section below" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“ˆ **History & Trends:** Preserved across runs via GitHub Pages" >> $GITHUB_STEP_SUMMARY

    - name: Deploy Allure Report to GitHub Pages
      if: contains(fromJSON('["refs/heads/main","refs/heads/master","refs/heads/develop"]'), github.ref)
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: target/allure-report/
        keep_files: false

